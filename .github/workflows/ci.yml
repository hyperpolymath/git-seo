# SPDX-License-Identifier: MIT
# SPDX-FileCopyrightText: 2025 hyperpolymath

name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:


permissions: read-all

jobs:
  test:
    name: Julia ${{ matrix.julia-version }} - ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        julia-version:
          - '1.9'
          - '1.10'
          - '1'  # Latest stable
        os:
          - ubuntu-latest
          - macos-latest
        exclude:
          - os: macos-latest
            julia-version: '1.9'

    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Setup Julia
        uses: julia-actions/setup-julia@5c9647d97b78a5debe5164e9eec09d653d29bd71 # v2.6.1
        with:
          version: ${{ matrix.julia-version }}

      - name: Cache Julia packages
        uses: actions/cache@9255dc7a253b0ccc959486e2bca901246202afeb # v5
        with:
          path: |
            ~/.julia/artifacts
            ~/.julia/packages
            ~/.julia/compiled
          key: julia-${{ matrix.julia-version }}-${{ hashFiles('Project.toml') }}
          restore-keys: |
            julia-${{ matrix.julia-version }}-

      - name: Install dependencies
        run: julia --project=. -e 'using Pkg; Pkg.instantiate()'

      - name: Run tests
        run: julia --project=. -e 'using Pkg; Pkg.test()'

  lint:
    name: SPDX & Documentation Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Check SPDX headers
        run: |
          missing=0
          for file in src/*.jl bin/git-seo; do
            if ! head -3 "$file" | grep -q "SPDX-License-Identifier"; then
              echo "::error file=$file::Missing SPDX header"
              missing=$((missing + 1))
            fi
          done
          if [ $missing -gt 0 ]; then
            exit 1
          fi
          echo "All source files have SPDX headers"

      - name: Check required files
        run: |
          required_files=(
            "README.adoc"
            "LICENSE.txt"
            "SECURITY.md"
            "CODE_OF_CONDUCT.adoc"
            "CONTRIBUTING.adoc"
          )
          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "::error::Missing required file: $file"
              exit 1
            fi
          done
          echo "All required documentation present"

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    permissions:
      security-events: write
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Check for secrets
        uses: trufflesecurity/trufflehog@05cccb53bc9e13bc6d17997db5a6bcc3df44bf2f
        with:
          extra_args: --only-verified

      - name: Check for hardcoded credentials
        run: |
          if grep -rn "password\s*=\s*['\"]" src/ bin/ 2>/dev/null; then
            echo "::error::Potential hardcoded credentials found"
            exit 1
          fi
          echo "No obvious credential leaks found"
